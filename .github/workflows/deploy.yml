# Created by Abdullah Umar Babsel
name: Deploy Go API

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Add VPS to known_hosts
        run: |
          ssh-keyscan -p ${{ secrets.VPS_PORT }} ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to VPS
        run: |
          ssh -p ${{ secrets.VPS_PORT }} ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            set -e

            echo "ðŸš€ Deploying Go API..."

            # Create app dir if not exists
            # mkdir -p ${{ secrets.VPS_PATH }}
            cd ${{ secrets.VPS_PATH }}

            # Clone repo if first time
            # if [ ! -d ".git" ]; then
            #   git clone https://github.com/${{ github.repository }} .
            # fi

            # Pull latest code
            git pull origin main
            
            # Rebuild and restart the containers
            # --build ensures the Dockerfile is re-processed with new code
            docker compose up -d --build
            
            # Cleanup old unused images to save VPS space
            docker image prune -f

            # Build & restart container
            # docker compose down
            # docker compose up -d --build

            echo "âœ… Deploy success"
          EOF
